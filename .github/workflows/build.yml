name: Build Electron Project for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build Electron project for Windows
        run: npm run build_win

      - name: FFmpeg Download
        run: Invoke-WebRequest -Uri https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-lgpl.zip -Outfile FFmpeg.zip 

      - name: Python Embeddable Download
        run: Invoke-WebRequest -Uri https://www.python.org/ftp/python/3.11.4/python-3.11.4-embed-amd64.zip -Outfile Python.zip

      - name: Setup dependencies
        shell: pwsh
        run: |
          Expand-Archive .\FFmpeg.zip -DestinationPath .\FFmpeg
          Copy-Item .\FFmpeg\ffmpeg-master-latest-win64-lgpl\bin\FFmpeg.exe .\build\win-unpacked\resources\app\src\FFmpeg\FFmpeg.exe
          Expand-Archive .\Python.zip -DestinationPath .\build\win-unpacked\resources\app\src\AITranscribe
          (Get-Content .build\win-unpacked\resources\app\src\AITranscribe\Python311._pth) -replace '#import site', 'import site' | Set-Content .build\win-unpacked\resources\app\src\AITranscribe\Python311._pth
          Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -Outfile .\build\win-unpacked\resources\app\src\AITranscribe\get-pip.py
          Start-Process .\build\win-unpacked\resources\app\src\AITranscribe\Python.exe -ArgmentList "get-pip.py"
          Start-Process .\build\win-unpacked\resources\app\src\AITranscribe\Python.exe -ArgmentList "-m pip install git+https://github.com/openai/whisper.git"

      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        with:
          name: AITranscribe-Electron
          #Path: build/*.zip
          path: build/win-unpacked/
